<UserControl x:Class="TempleLampSystem.Views.LampOrderView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:converters="clr-namespace:TempleLampSystem.Converters">

    <UserControl.Resources>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibility"/>
        <converters:OrderStatusToColorConverter x:Key="StatusToColor"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibility"/>
        <converters:NotNullToVisibilityConverter x:Key="NotNullToVisibility"/>
    </UserControl.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- 已選客戶資訊 -->
        <GroupBox Grid.Row="0" Header="已選客戶" Margin="0,0,0,10">
            <Grid Margin="10">
                <TextBlock Text="請從左側選擇客戶"
                           Foreground="Gray"
                           Visibility="{Binding SelectedCustomer, Converter={StaticResource NullToVisibility}}"/>

                <StackPanel Visibility="{Binding SelectedCustomer, Converter={StaticResource NotNullToVisibility}}">
                    <TextBlock FontSize="18" FontWeight="Bold"
                               Text="{Binding SelectedCustomer.Name}"/>
                    <TextBlock Foreground="Gray" Margin="0,5,0,0">
                        <Run Text="電話："/>
                        <Run Text="{Binding SelectedCustomer.Phone, Mode=OneWay}"/>
                        <Run Text=" / 手機："/>
                        <Run Text="{Binding SelectedCustomer.Mobile, Mode=OneWay}"/>
                    </TextBlock>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- 點燈表單 -->
        <GroupBox Grid.Row="1" Header="新增點燈" Margin="0,0,0,10">
            <Grid Margin="10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="80"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- 燈種選擇 -->
                <TextBlock Grid.Row="0" Text="燈種：" VerticalAlignment="Center"/>
                <ComboBox Grid.Row="0" Grid.Column="1"
                          ItemsSource="{Binding Lamps}"
                          SelectedItem="{Binding SelectedLamp}"
                          DisplayMemberPath="LampName"
                          Padding="5"
                          Margin="0,0,0,10"/>

                <!-- 金額 -->
                <TextBlock Grid.Row="1" Text="金額：" VerticalAlignment="Center"/>
                <TextBox Grid.Row="1" Grid.Column="1"
                         Text="{Binding Price, UpdateSourceTrigger=PropertyChanged}"
                         Padding="5"
                         Margin="0,0,0,10"/>

                <!-- 狀態提示 - 不可點燈 -->
                <Border Grid.Row="2" Grid.ColumnSpan="2"
                        Background="#FFEBEE"
                        CornerRadius="5"
                        Padding="10"
                        Margin="0,0,0,10"
                        Visibility="{Binding CannotOrderReason, Converter={StaticResource NotNullToVisibility}}">
                    <TextBlock Text="{Binding CannotOrderReason}"
                               Foreground="#C62828"
                               TextWrapping="Wrap"/>
                </Border>

                <!-- 狀態提示 - 可點燈 -->
                <Border Grid.Row="2" Grid.ColumnSpan="2"
                        Background="#E8F5E9"
                        CornerRadius="5"
                        Padding="10"
                        Margin="0,0,0,10"
                        Visibility="{Binding CanOrder, Converter={StaticResource BoolToVisibility}}">
                    <TextBlock Text="✓ 可以點燈" Foreground="#2E7D32"/>
                </Border>

                <!-- 點燈按鈕 -->
                <Button Grid.Row="3" Grid.ColumnSpan="2"
                        Content="確認點燈"
                        Command="{Binding CreateOrderCommand}"
                        IsEnabled="{Binding CanOrder}"
                        Padding="15,10"
                        FontSize="14"
                        Background="#4CAF50"
                        Foreground="White"
                        Margin="0,0,0,10"/>

                <!-- 列印按鈕 -->
                <StackPanel Grid.Row="4" Grid.ColumnSpan="2"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right">
                    <Button Content="預覽單據"
                            Command="{Binding PreviewReceiptCommand}"
                            Padding="10,5"
                            Margin="0,0,5,0"/>
                    <Button Content="列印/PDF"
                            Command="{Binding PrintLastOrderCommand}"
                            Padding="10,5"/>
                </StackPanel>
            </Grid>
        </GroupBox>

        <!-- 即將到期提醒 -->
        <GroupBox Grid.Row="2" Header="即將到期提醒（30天內）">
            <ListView ItemsSource="{Binding ExpiringOrders}" Margin="5">
                <ListView.View>
                    <GridView>
                        <GridViewColumn Header="客戶" Width="80" DisplayMemberBinding="{Binding CustomerName}"/>
                        <GridViewColumn Header="燈種" Width="70" DisplayMemberBinding="{Binding LampName}"/>
                        <GridViewColumn Header="到期日" Width="85" DisplayMemberBinding="{Binding EndDate, StringFormat=yyyy/MM/dd}"/>
                        <GridViewColumn Header="剩餘" Width="60">
                            <GridViewColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding DaysLeft, StringFormat='{}{0}天'}"
                                               Foreground="{Binding EndDate, Converter={StaticResource StatusToColor}}"/>
                                </DataTemplate>
                            </GridViewColumn.CellTemplate>
                        </GridViewColumn>
                    </GridView>
                </ListView.View>
            </ListView>
        </GroupBox>

        <!-- 雲端同步 -->
        <GroupBox Grid.Row="3" Header="雲端同步" Margin="0,10,0,0">
            <StackPanel Margin="10">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="↑ 上傳至雲端"
                            Command="{Binding SyncToCloudCommand}"
                            Padding="15,8"
                            Margin="0,0,10,0"/>
                    <Button Content="↓ 從雲端下載"
                            Command="{Binding SyncFromCloudCommand}"
                            Padding="15,8"/>
                </StackPanel>
                <TextBlock Text="{Binding SyncStatus}"
                           HorizontalAlignment="Center"
                           Foreground="Gray"
                           Margin="0,10,0,0"/>
            </StackPanel>
        </GroupBox>

        <!-- 狀態列 -->
        <TextBlock Grid.Row="4"
                   Text="{Binding StatusMessage}"
                   Foreground="Gray"
                   Margin="0,10,0,0"/>
    </Grid>
</UserControl>
